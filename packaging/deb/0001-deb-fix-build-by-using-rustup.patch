From ec722dbd618817165bce740e821ffff7c8a88e83 Mon Sep 17 00:00:00 2001
From: R1kaB3rN <100738684+R1kaB3rN@users.noreply.github.com>
Date: Sun, 10 Aug 2025 20:45:09 -0700
Subject: [PATCH] deb: update rustup patch

---
 Makefile.in                           | 17 ++++++++++++-----
 packaging/deb/debian/bookworm/control |  1 +
 2 files changed, 13 insertions(+), 5 deletions(-)

diff --git a/Makefile.in b/Makefile.in
index 1ad390ff..e4088650 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -2,6 +2,7 @@ PROJECT := umu-launcher
 
 # Define the interpreters to use to prevent shebang complaints
 PYTHON_INTERPRETER = /usr/bin/env python3
+SHELL_INTERPRETER = /usr/bin/env sh
 
 # If this is changed to umu (uppercase), `uninstall` target will also remove the SLR directory
 INSTALLDIR ?= umu
@@ -84,6 +85,7 @@ else
 umu-install: umu-dist-install umu-delta-install umu-docs-install
 endif
 
+URLLIB3_URL := https://github.com/urllib3/urllib3/releases/download/2.5.0/urllib3-2.5.0-py3-none-any.whl
 
 $(OBJDIR)/.build-umu-vendored: | $(OBJDIR)
 	$(info :: Building vendored dependencies )
@@ -92,9 +94,7 @@ $(OBJDIR)/.build-umu-vendored: | $(OBJDIR)
 		cd subprojects/pyzstd && $(PYTHON_INTERPRETER) -m build -wn -C=--build-option=--dynamic-link-zstd --outdir=$(OBJDIR); \
 	fi
 	@if [ "$(USE_SYSTEM_URLLIB)" != "xtrue" ]; then \
-		cd subprojects/urllib3 && \
-		sed -i 's/license-files = \["LICENSE.txt"\]//g' pyproject.toml && \
-		$(PYTHON_INTERPRETER) -m build -wn --outdir=$(OBJDIR); \
+		curl -LJO --tlsv1.3 $(URLLIB3_URL) --output-dir $(OBJDIR); \
 	fi
 	touch $(@)
 
@@ -109,7 +109,7 @@ umu-vendored-install: umu-vendored
 		find $(DESTDIR)$(PYTHONDIR)/umu/_vendor -type d -name pyzstd | xargs -I {} mv {} $(DESTDIR)$(PYTHONDIR)/umu/_vendor; \
 	fi
 	@if [ "$(USE_SYSTEM_URLLIB)" != "xtrue" ]; then \
-		$(PYTHON_INTERPRETER) -m installer --destdir=$(DESTDIR)$(PYTHONDIR)/umu/_vendor subprojects/urllib3/$(OBJDIR)/urllib3*.whl; \
+		$(PYTHON_INTERPRETER) -m installer --destdir=$(DESTDIR)$(PYTHONDIR)/umu/_vendor $(OBJDIR)/urllib3*.whl; \
 		find $(DESTDIR)$(PYTHONDIR)/umu/_vendor -type d -name urllib3 | xargs -I {} mv {} $(DESTDIR)$(PYTHONDIR)/umu/_vendor; \
 	fi
 	@if [ "$(USE_SYSTEM_PYZSTD)" != "xtrue" ] || [ "$(USE_SYSTEM_URLLIB)" != "xtrue" ]; then \
@@ -173,10 +173,17 @@ zipapp-install: zipapp
 	@echo "Standalone application 'umu-run' created at '$(DESTDIR)$(PREFIX)/bin'"
 
 PYTHON_PLATFORM_TAG = $(shell $(PYTHON_INTERPRETER) -c 'import sysconfig; print(sysconfig.get_config_var("EXT_SUFFIX"))')
+CARGO_BIN := $(HOME)/.cargo/bin/cargo
+RUSTUP_BIN := $(HOME)/.cargo/bin/rustup
+RUSTUP_URL := https://raw.githubusercontent.com/rust-lang/rustup/refs/tags/1.27.1/rustup-init.sh
 
 $(OBJDIR)/.build-umu-delta: | $(OBJDIR)
 	$(info :: Building delta dependencies )
-	cargo build -r --target-dir $(OBJDIR)
+	curl -LJO --tlsv1.3 $(RUSTUP_URL)
+	chmod u+x ./rustup-init.sh
+	$(SHELL_INTERPRETER) rustup-init.sh --default-toolchain none -y
+	$(RUSTUP_BIN) toolchain install 1.65
+	$(CARGO_BIN) build -r --target-dir $(OBJDIR)
 	touch $(@)
 
 .PHONY: umu-delta
diff --git a/packaging/deb/debian/bookworm/control b/packaging/deb/debian/bookworm/control
index adfd8025..b725d9f5 100644
--- a/packaging/deb/debian/bookworm/control
+++ b/packaging/deb/debian/bookworm/control
@@ -18,6 +18,7 @@ Build-Depends:
  python3-hatch-vcs,
  libzstd-dev,
  python3-dev,
+ curl,
 Standards-Version: 4.6.2
 Homepage: https://github.com/Open-Wine-Components/umu-launcher
 Vcs-Browser: https://github.com/Open-Wine-Components/umu-launcher
-- 
2.50.1

